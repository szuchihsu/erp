<% content_for :title, "Design Request ##{@design_request.id}" %>

<div class="w-full max-w-6xl mx-auto">
  <!-- Header Section -->
  <div class="mb-8">
    <div class="flex justify-between items-start">
      <div>
        <h1 class="text-3xl font-bold text-gray-900">Design Request #<%= @design_request.id %></h1>
        <p class="mt-2 text-gray-600">
          Requested by <%= @design_request.customer.name %> on <%= @design_request.requested_date.strftime('%B %d, %Y') %>
        </p>
      </div>
      <div class="flex space-x-3">
        <%= link_to edit_design_request_path(@design_request), 
            class: "bg-gray-600 hover:bg-gray-700 text-white px-4 py-2 rounded-md font-medium" do %>
          Edit Request
        <% end %>
        <%= link_to design_requests_path, 
            class: "text-gray-600 hover:text-gray-800 px-4 py-2 border border-gray-300 rounded-md" do %>
          Back to List
        <% end %>
      </div>
    </div>
  </div>

  <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
    <!-- Main Content -->
    <div class="lg:col-span-2 space-y-6">
      <!-- Request Details -->
      <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
        <h2 class="text-lg font-semibold text-gray-900 mb-4">Request Details</h2>
        
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Status</label>
            <span class="inline-flex px-3 py-1 text-sm font-semibold rounded-full <%= @design_request.status_badge_class %>">
              <%= @design_request.status&.humanize || 'Unknown' %>
            </span>
          </div>
          
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Priority</label>
            <span class="inline-flex px-3 py-1 text-sm font-semibold rounded-full <%= @design_request.priority_badge_class %>">
              <%= @design_request.priority&.humanize || 'Unknown' %>
            </span>
          </div>
          
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Assigned Designer</label>
            <% if @design_request.assigned_designer %>
              <p class="text-gray-900"><%= @design_request.assigned_designer.name %></p>
            <% else %>
              <p class="text-gray-500">Not assigned</p>
            <% end %>
          </div>
          
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Days Pending</label>
            <p class="text-gray-900">
              <%= @design_request.days_pending %> days
              <% if @design_request.overdue? %>
                <span class="text-red-600 font-medium">(Overdue)</span>
              <% end %>
            </p>
          </div>
        </div>
        
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">Design Details</label>
          <div class="bg-gray-50 rounded-md p-4">
            <p class="text-gray-900 whitespace-pre-line"><%= @design_request.design_details %></p>
          </div>
        </div>
      </div>

      <!-- Design Images -->
      <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
        <div class="flex justify-between items-center mb-4">
          <h2 class="text-lg font-semibold text-gray-900">Design Images</h2>
          <% if @design_request.status.in?(['assigned', 'in_progress', 'review']) %>
            <button type="button" 
                    onclick="document.getElementById('upload-modal').classList.remove('hidden')"
                    class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-md text-sm font-medium">
              Upload Image
            </button>
          <% end %>
        </div>

        <% if @design_images.any? %>
          <!-- Final Designs -->
          <% if @final_images.any? %>
            <div class="mb-8">
              <h3 class="text-md font-medium text-gray-900 mb-4 flex items-center">
                <span class="w-2 h-2 bg-green-500 rounded-full mr-2"></span>
                Final Designs
              </h3>
              <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                <% @final_images.each do |image| %>
                  <div class="border border-gray-200 rounded-lg overflow-hidden">
                    <% if image.image_file.attached? %>
                      <%= image_tag image.image_file, class: "w-full h-48 object-cover" %>
                    <% else %>
                      <div class="w-full h-48 bg-gray-100 flex items-center justify-center">
                        <span class="text-gray-500">No image</span>
                      </div>
                    <% end %>
                    <div class="p-3">
                      <p class="text-sm font-medium text-gray-900"><%= image.display_name %></p>
                      <p class="text-xs text-gray-500 mt-1">
                        Uploaded <%= image.created_at.strftime('%b %d, %Y') %>
                      </p>
                    </div>
                  </div>
                <% end %>
              </div>
            </div>
          <% end %>

          <!-- Work in Progress Images -->
          <% if @work_images.any? %>
            <div>
              <h3 class="text-md font-medium text-gray-900 mb-4 flex items-center">
                <span class="w-2 h-2 bg-blue-500 rounded-full mr-2"></span>
                Work in Progress
              </h3>
              <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                <% @work_images.each do |image| %>
                  <div class="border border-gray-200 rounded-lg overflow-hidden">
                    <% if image.image_file.attached? %>
                      <%= image_tag image.image_file, class: "w-full h-32 object-cover" %>
                    <% else %>
                      <div class="w-full h-32 bg-gray-100 flex items-center justify-center">
                        <span class="text-gray-500 text-xs">No image</span>
                      </div>
                    <% end %>
                    <div class="p-2">
                      <p class="text-xs font-medium text-gray-900"><%= image.image_type.humanize %></p>
                      <p class="text-xs text-gray-500"><%= image.description %></p>
                    </div>
                  </div>
                <% end %>
              </div>
            </div>
          <% end %>
        <% else %>
          <div class="text-center py-12">
            <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
            </svg>
            <h3 class="mt-2 text-sm font-medium text-gray-900">No images yet</h3>
            <p class="mt-1 text-sm text-gray-500">Design images will appear here once uploaded.</p>
          </div>
        <% end %>
      </div>
    </div>

    <!-- Sidebar -->
    <div class="space-y-6">
      <!-- Customer Information -->
      <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
        <h3 class="text-lg font-semibold text-gray-900 mb-4">Customer Information</h3>
        <div class="space-y-3">
          <div>
            <label class="block text-sm font-medium text-gray-700">Name</label>
            <p class="text-gray-900"><%= @design_request.customer.name %></p>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700">Email</label>
            <p class="text-gray-900"><%= @design_request.customer.email %></p>
          </div>
          <% if @design_request.customer.phone %>
            <div>
              <label class="block text-sm font-medium text-gray-700">Phone</label>
              <p class="text-gray-900"><%= @design_request.customer.phone %></p>
            </div>
          <% end %>
        </div>
      </div>

      <!-- Related Sales Order -->
      <% if @design_request.sales_order %>
        <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
          <h3 class="text-lg font-semibold text-gray-900 mb-4">Related Order</h3>
          <div class="space-y-3">
            <div>
              <label class="block text-sm font-medium text-gray-700">Order ID</label>
              <p class="text-gray-900">
                <%= link_to "##{@design_request.sales_order.id}", @design_request.sales_order, 
                    class: "text-blue-600 hover:text-blue-800" %>
              </p>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700">Status</label>
              <p class="text-gray-900"><%= @design_request.sales_order.order_status.humanize %></p>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700">Total Amount</label>
              <p class="text-gray-900">$<%= number_with_precision(@design_request.sales_order.total_amount, precision: 2) %></p>
            </div>
          </div>
        </div>
      <% end %>

      <!-- Actions -->
      <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
        <h3 class="text-lg font-semibold text-gray-900 mb-4">Actions</h3>
        <div class="space-y-3">
          <!-- Assignment -->
          <% unless @design_request.assigned_designer %>
            <button type="button" 
                    onclick="document.getElementById('assign-modal').classList.remove('hidden')"
                    class="w-full bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-md text-sm font-medium">
              Assign Designer
            </button>
          <% end %>

          <!-- Status Updates -->
          <% case @design_request.status %>
          <% when 'pending', 'assigned' %>
            <%= link_to "Start Working", 
                design_request_path(@design_request, design_request: { status: 'in_progress' }), 
                method: :patch,
                class: "w-full bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-md text-sm font-medium text-center block" %>
          <% when 'in_progress' %>
            <%= link_to "Submit for Review", 
                design_request_path(@design_request, design_request: { status: 'review' }), 
                method: :patch,
                class: "w-full bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-md text-sm font-medium text-center block" %>
          <% when 'review' %>
            <% if @design_request.can_be_approved? %>
              <%= link_to "Approve Design", 
                  approve_design_request_path(@design_request), 
                  method: :patch,
                  data: { confirm: 'Are you sure you want to approve this design?' },
                  class: "w-full bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-md text-sm font-medium text-center block" %>
            <% else %>
              <p class="text-sm text-gray-500 mb-2">Final design images required for approval</p>
            <% end %>
            <%= link_to "Request Revision", 
                design_request_path(@design_request, design_request: { status: 'revision_needed' }), 
                method: :patch,
                class: "w-full bg-orange-600 hover:bg-orange-700 text-white px-4 py-2 rounded-md text-sm font-medium text-center block" %>
            <%= link_to "Reject Design", 
                reject_design_request_path(@design_request), 
                method: :patch,
                data: { confirm: 'Are you sure you want to reject this design?' },
                class: "w-full bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-md text-sm font-medium text-center block" %>
          <% when 'revision_needed' %>
            <%= link_to "Resume Work", 
                design_request_path(@design_request, design_request: { status: 'in_progress' }), 
                method: :patch,
                class: "w-full bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-md text-sm font-medium text-center block" %>
          <% end %>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Upload Image Modal -->
<div id="upload-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
  <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
    <div class="mt-3">
      <h3 class="text-lg font-medium text-gray-900 mb-4">Upload Design Image</h3>
      <%= form_with model: [@design_request, DesignImage.new], multipart: true, local: true do |f| %>
        <div class="space-y-4">
          <div>
            <%= f.label :image_type, class: "block text-sm font-medium text-gray-700 mb-2" %>
            <%= f.select :image_type, options_for_select([
                  ['Sketch', 'sketch'],
                  ['3D Render', 'render'],
                  ['Technical Drawing', 'technical'],
                  ['Reference Image', 'reference'],
                  ['Final Design', 'final']
                ]), 
                { prompt: 'Select type...' },
                { class: "block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500" } %>
          </div>
          
          <div>
            <%= f.label :description, class: "block text-sm font-medium text-gray-700 mb-2" %>
            <%= f.text_field :description, 
                placeholder: "Brief description...",
                class: "block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500" %>
          </div>
          
          <div>
            <%= f.label :image_file, "Image File", class: "block text-sm font-medium text-gray-700 mb-2" %>
            <%= f.file_field :image_file, accept: "image/*",
                class: "block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:text-sm file:font-medium file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100" %>
          </div>
          
          <div class="flex items-center">
            <%= f.check_box :is_final, class: "rounded border-gray-300 text-blue-600 shadow-sm focus:border-blue-500 focus:ring-blue-500" %>
            <%= f.label :is_final, "This is a final design", class: "ml-2 text-sm text-gray-700" %>
          </div>
        </div>
        
        <div class="flex justify-end space-x-3 mt-6">
          <button type="button" 
                  onclick="document.getElementById('upload-modal').classList.add('hidden')"
                  class="px-4 py-2 border border-gray-300 rounded-md text-gray-700 hover:bg-gray-50">
            Cancel
          </button>
          <%= f.submit "Upload Image", 
              class: "px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700" %>
        </div>
      <% end %>
    </div>
  </div>
</div>

<!-- Assign Designer Modal -->
<div id="assign-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
  <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
    <div class="mt-3">
      <h3 class="text-lg font-medium text-gray-900 mb-4">Assign Designer</h3>
      <%= form_with url: assign_design_request_path(@design_request), method: :patch, local: true do |f| %>
        <div class="mb-4">
          <%= f.label :designer_id, "Select Designer", class: "block text-sm font-medium text-gray-700 mb-2" %>
          <%= f.select :designer_id, 
              options_from_collection_for_select(Employee.designers.active, :id, :name), 
              { prompt: 'Choose a designer...' },
              { class: "block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500" } %>
        </div>
        
        <div class="flex justify-end space-x-3">
          <button type="button" 
                  onclick="document.getElementById('assign-modal').classList.add('hidden')"
                  class="px-4 py-2 border border-gray-300 rounded-md text-gray-700 hover:bg-gray-50">
            Cancel
          </button>
          <%= f.submit "Assign Designer", 
              class: "px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700" %>
        </div>
      <% end %>
    </div>
  </div>
</div>
